#!/usr/bin/env python3
"""
lora_dewhiten.py — LoRa Codeword Dewhitening (RX Stage 6)
===========================================================

Removes the whitening (PRNG XOR mask) applied by the LoRa transmitter.

gr-lora reference (decoder_impl.cc, dewhiten(), ~line 639):
─────────────────────────────────────────────────────────────
Each codeword byte is XORed with the corresponding byte from a pre-computed
PRNG table:

    dewhitened[i] = deshuffled[i] ^ prng[i]

The PRNG differs for header vs. payload:
  • Header  : prng_header[]       — ALL ZEROS  (whitening is a no-op!)
  • Payload : prng_payload_cr78[] — for CR 3–4  (our CR=4 case)
              prng_payload_cr56[] — for CR 1–2

Tables copied verbatim from gr-lora/lib/tables.h.

PRNG indexing:
  The PRNG index resets to 0 for each decode() call.  Since gr-lora
  prepends the 6th header codeword to the payload stream (see Stage 5
  deshuffle notes), prng_payload[0] is XORed with that spillover codeword
  and prng_payload[1] with the first actual payload codeword.

Pipeline position:
  … → Deinterleave → Deshuffle → **[Dewhiten]** → Hamming decode
  → Byte assembly → CRC check
"""

import json
import argparse
from typing import List


# ══════════════════════════════════════════════════════════════════════════════
#  PRNG WHITENING TABLES — from gr-lora/lib/tables.h
# ══════════════════════════════════════════════════════════════════════════════

# Header whitening: all zeros → dewhitening is a no-op for the header.
PRNG_HEADER = [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00
]

# Payload whitening for CR 3–4  (Hamming(7,4) and Hamming(8,4))
# This is the sequence we need for CR = 4.
PRNG_PAYLOAD_CR78 = [
    0xff, 0xff, 0x2d, 0xff, 0x78, 0xff, 0xe1, 0xff,
    0x00, 0xff, 0xd2, 0x2d, 0x55, 0x78, 0x4b, 0xe1,
    0x66, 0x00, 0x1e, 0xd2, 0xff, 0x55, 0x2d, 0x4b,
    0x78, 0x66, 0xe1, 0x1e, 0xd2, 0xff, 0x87, 0x2d,
    0xcc, 0x78, 0xaa, 0xe1, 0xb4, 0xd2, 0x99, 0x87,
    0xe1, 0xcc, 0x00, 0xaa, 0x00, 0xb4, 0x00, 0x99,
    0x00, 0xe1, 0xd2, 0x00, 0x55, 0x00, 0x99, 0x00,
    0xe1, 0x00, 0xd2, 0xd2, 0x87, 0x55, 0x1e, 0x99,
    0x2d, 0xe1, 0x78, 0xd2, 0xe1, 0x87, 0xd2, 0x1e,
    0x55, 0x2d, 0x99, 0x78, 0x33, 0xe1, 0x55, 0xd2,
    0x4b, 0x55, 0x66, 0x99, 0x1e, 0x33, 0x2d, 0x55,
    0x78, 0x4b, 0xe1, 0x66, 0x00, 0x1e, 0x00, 0x2d,
    0x00, 0x78, 0xd2, 0xe1, 0x87, 0x00, 0xcc, 0x00,
    0x78, 0x00, 0x33, 0xd2, 0x55, 0x87, 0x99, 0xcc,
    0x33, 0x78, 0x55, 0x33, 0x99, 0x55, 0x33, 0x99,
    0x87, 0x33, 0xcc, 0x55, 0xaa, 0x99, 0x66, 0x33,
    0x1e, 0x87, 0x2d, 0xcc, 0x78, 0xaa, 0x33, 0x66,
    0x55, 0x1e, 0x99, 0x2d, 0xe1, 0x78, 0x00, 0x33,
    0x00, 0x55, 0xd2, 0x99, 0x55, 0xe1, 0x4b, 0x00,
    0xb4, 0x00, 0x4b, 0xd2, 0x66, 0x55, 0xcc, 0x4b,
    0xaa, 0xb4, 0x66, 0x4b, 0xcc, 0x66, 0xaa, 0xcc,
    0xb4, 0xaa, 0x4b, 0x66, 0x66, 0xcc, 0xcc, 0xaa,
    0x78, 0xb4, 0x33, 0x4b, 0x55, 0x66, 0x4b, 0xcc,
    0x66, 0x78, 0xcc, 0x33, 0x78, 0x55, 0xe1, 0x4b,
    0x00, 0x66, 0xd2, 0xcc, 0x87, 0x78, 0x1e, 0xe1,
    0xff, 0x00, 0xff, 0xd2, 0x2d, 0x87, 0xaa, 0x1e,
    0x66, 0xff, 0xcc, 0xff, 0xaa, 0x2d, 0x66, 0xaa,
    0x1e, 0x66, 0xff, 0xcc, 0x2d, 0xaa, 0xaa, 0x66,
    0xb4, 0x1e, 0x4b, 0xff, 0x66, 0x2d, 0x1e, 0xaa,
    0x2d, 0xb4, 0xaa, 0x4b, 0xb4, 0x66, 0x99, 0x1e,
    0xe1, 0x2d, 0xd2, 0xaa, 0x55, 0xb4, 0x99, 0x99,
    0xe1, 0xe1, 0x00, 0xd2, 0xd2, 0x55, 0x87, 0x99,
    0xcc, 0xe1, 0xaa, 0x00, 0x66, 0xd2, 0xcc, 0x87,
    0x78, 0xcc, 0xe1, 0xaa, 0xd2, 0x66, 0x87, 0xcc,
    0x1e, 0x78, 0xff, 0xe1, 0x2d, 0xd2, 0x78, 0x87,
    0x33, 0x1e, 0x87, 0xff, 0x1e, 0x2d, 0x2d, 0x78,
    0x78, 0x33, 0x33, 0x87, 0x87, 0x1e, 0xcc, 0x2d,
    0x78, 0x78, 0xe1, 0x33, 0xd2, 0x87, 0x55, 0xcc,
    0x4b, 0x78, 0x66, 0xe1, 0xcc, 0xd2, 0xaa, 0x55,
    0xb4, 0x4b, 0x99, 0x66, 0x33, 0xcc, 0x55, 0xaa,
    0x99, 0xb4, 0xe1, 0x99, 0xd2, 0x33, 0x55, 0x55,
    0x4b, 0x99, 0xb4, 0xe1, 0x99, 0xd2, 0x33, 0x55,
    0x55, 0x4b, 0x4b, 0xb4, 0xb4, 0x99, 0x4b, 0x33,
    0xb4, 0x55, 0x99, 0x4b, 0x33, 0xb4, 0x87, 0x4b,
    0x1e, 0xb4, 0x2d, 0x99, 0xaa, 0x33, 0x66, 0xc7,
    0x1e, 0x1e, 0x2d, 0x2d, 0xaa, 0xaa, 0x66, 0x66,
    0xcc, 0x1e, 0x78, 0x2d, 0x33, 0xaa, 0x87, 0x66,
    0x1e, 0xcc, 0xff, 0x78, 0x2d, 0x33, 0xaa, 0x87,
    0x66, 0x1e, 0x1e, 0xff, 0xff, 0x2d, 0xff, 0xaa,
    0xff, 0x66, 0x2d, 0x1e, 0xaa, 0xff, 0xb4, 0xff,
    0x99, 0xff, 0x33, 0x2d, 0x87, 0xaa, 0xcc, 0xb4,
    0x78, 0x99, 0x33, 0x33, 0x87, 0x87, 0xcc, 0xcc,
    0xaa, 0x78, 0xb4, 0x33, 0x4b, 0x87, 0xb4, 0xcc,
    0x99, 0xaa, 0xe1, 0xb4, 0xd2, 0x4b, 0x87, 0xb4,
    0xcc, 0x99, 0x78, 0xe1, 0xe1, 0xd2, 0x00, 0x87,
    0x00, 0xcc, 0xd2, 0x78, 0x87, 0xe1, 0x1e, 0x00,
    0x2d, 0x00, 0xaa, 0xd2, 0xb4, 0x87, 0x4b, 0x1e,
    0xb4, 0x2d, 0x4b, 0xaa, 0xb4, 0xb4, 0x4b, 0x4b,
    0x66, 0xb4, 0x1e, 0x4b, 0xff, 0xb4, 0xff, 0x4b,
    0x2d, 0x66, 0x78, 0x1e, 0x33, 0xff, 0x55, 0xff,
    0x4b, 0x2d, 0xb4, 0x78, 0x99, 0x33, 0xe1, 0x55,
    0x00, 0x4b, 0xd2, 0xb4, 0x55, 0x99, 0x99, 0xe1,
    0x33, 0x00, 0x87, 0xd2, 0x1e, 0x55, 0xff, 0x99,
    0xff, 0x33, 0xff, 0x87, 0xff, 0x1e, 0x00, 0x00,
    0x00, 0x00, 0x87, 0xe1, 0xaa, 0xcc,
]

# Payload whitening for CR 1–2  (Hamming(5,4) and Hamming(6,4))
# Included for completeness; not used in our CR=4 pipeline.
PRNG_PAYLOAD_CR56 = [
    0xff, 0xff, 0x2d, 0xff, 0x78, 0xff, 0x30, 0x2e,
    0x0, 0x2e, 0x12, 0x3c, 0x14, 0x28, 0xa, 0x30,
    0x36, 0x0, 0x1e, 0x12, 0x2e, 0x14, 0x3c, 0xa,
    0x28, 0x36, 0x30, 0x1e, 0x12, 0x2e, 0x6, 0x3c,
    0xc, 0x28, 0x3a, 0x30, 0x24, 0x12, 0x18, 0x6,
    0x30, 0xc, 0x0, 0x3a, 0x0, 0x24, 0x0, 0x18,
    0x0, 0x30, 0x12, 0x0, 0x14, 0x0, 0x18, 0x0,
    0x30, 0x0, 0x12, 0x12, 0x6, 0x14, 0x1e, 0x18,
    0x3c, 0x30, 0x28, 0x12, 0x30, 0x6, 0x12, 0x1e,
    0x14, 0x3c, 0x18, 0x28, 0x22, 0x30, 0x14, 0x12,
    0xa, 0x14, 0x36, 0x18, 0x1e, 0x22, 0x3c, 0x14,
    0x28, 0xa, 0x30, 0x36, 0x0, 0x1e, 0x0, 0x3c,
    0x0, 0x28, 0x12, 0x30, 0x6, 0x0, 0xc, 0x0,
    0x28, 0x0, 0x22, 0x12, 0x14, 0x6, 0x18, 0xc,
    0x22, 0x28, 0x14, 0x22, 0x18, 0x14, 0x22, 0x18,
    0x6, 0x22, 0xc, 0x14, 0x3a, 0x18, 0x36, 0x22,
    0x1e, 0x6, 0x3c, 0xc, 0x28, 0x3a, 0x22, 0x36,
    0x14, 0x1e, 0x18, 0x3c, 0x30, 0x28, 0x0, 0x22,
    0x0, 0x14, 0x12, 0x18, 0x14, 0x30, 0xa, 0x0,
    0x24, 0x0, 0xa, 0x12, 0x36, 0x14, 0xc, 0xa,
    0x3a, 0x24, 0x36, 0xa, 0xc, 0x36, 0x3a, 0xc,
    0x24, 0x3a, 0xa, 0x36, 0x36, 0xc, 0xc, 0x3a,
    0x28, 0x24, 0x22, 0xa, 0x14, 0x36, 0xa, 0xc,
    0x36, 0x28, 0xc, 0x22, 0x28, 0x14, 0x30, 0xa,
    0x0, 0x36, 0x12, 0xc, 0x6, 0x28, 0x1e, 0x30,
    0x2e, 0x0, 0x2e, 0x12, 0x3c, 0x6, 0x3a, 0x1e,
    0x36, 0x2e, 0xc, 0x2e, 0x3a, 0x3c, 0x36, 0x3a,
    0x1e, 0x36, 0x2e, 0xc, 0x3c, 0x3a, 0x3a, 0x36,
    0x24, 0x1e, 0xa, 0x2e, 0x36, 0x3c, 0x1e, 0x3a,
    0x3c, 0x24, 0x3a, 0xa, 0x24, 0x36, 0x18, 0x1e,
    0x30, 0x3c, 0x12, 0x3a, 0x14, 0x24, 0x18, 0x18,
    0x30, 0x30, 0x0, 0x12, 0x12, 0x14, 0x6, 0x18,
    0xc, 0x30, 0x3a, 0x0, 0x36, 0x12, 0xc, 0x6,
    0x28, 0xc, 0x30, 0x3a, 0x12, 0x36, 0x6, 0xc,
    0x1e, 0x28, 0x2e, 0x30, 0x3c, 0x12, 0x28, 0x6,
    0x22, 0x1e, 0x6, 0x2e, 0x1e, 0x3c, 0x3c, 0x28,
    0x28, 0x22, 0x22, 0x6, 0x6, 0x1e, 0xc, 0x3c,
    0x28, 0x28, 0x30, 0x22, 0x12, 0x6, 0x14, 0xc,
    0xa, 0x28, 0x36, 0x30, 0xc, 0x12, 0x3a, 0x14,
    0x24, 0xa, 0x18, 0x36, 0x22, 0xc, 0x14, 0x3a,
    0x18, 0x24, 0x30, 0x18, 0x12, 0x22, 0x14, 0x14,
    0xa, 0x18, 0x24, 0x30, 0x18, 0x12, 0x22, 0x14,
    0x14, 0xa, 0xa, 0x24, 0x24, 0x18, 0xa, 0x22,
    0x24, 0x14, 0x18, 0xa, 0x22, 0x24, 0x6, 0xa,
    0x1e, 0x24, 0x3c, 0x18, 0x3a, 0x22, 0x36, 0x6,
    0x1e, 0x1e, 0x3c, 0x3c, 0x3a, 0x3a, 0x36, 0x36,
    0xc, 0x1e, 0x28, 0x3c, 0x22, 0x3a, 0x6, 0x36,
    0x1e, 0xc, 0x2e, 0x28, 0x3c, 0x22, 0x3a, 0x6,
    0x36, 0x1e, 0x1e, 0x2e, 0x2e, 0x3c, 0x2e, 0x3a,
    0x2e, 0x36, 0x3c, 0x1e, 0x3a, 0x2e, 0x24, 0x2e,
    0x18, 0x2e, 0x22, 0x3c, 0x6, 0x3a, 0xc, 0x24,
    0x28, 0x18, 0x22, 0x22, 0x6, 0x6, 0xc, 0xc,
    0x3a, 0x28, 0x24, 0x22, 0xa, 0x6, 0x24, 0xc,
    0x18, 0x3a, 0x30, 0x24, 0x12, 0xa, 0x6, 0x24,
    0xc, 0x18, 0x28, 0x30, 0x30, 0x12, 0x0, 0x6,
    0x0, 0xc, 0x12, 0x28, 0x6, 0x30, 0x1e, 0x0,
    0x3c, 0x0, 0x3a, 0x12, 0x24, 0x6, 0xa, 0x1e,
    0x24, 0x3c, 0xa, 0x3a, 0x24, 0x24, 0xa, 0xa,
    0x36, 0x24, 0x1e, 0xa, 0x2e, 0x24, 0x2e, 0xa,
    0x3c, 0x36, 0x28, 0x1e, 0x22, 0x2e, 0x14, 0x2e,
    0xa, 0x3c, 0x24, 0x28, 0x18, 0x22, 0x30, 0x14,
    0x0, 0xa, 0x12, 0x24, 0x14, 0x18, 0x18, 0x30,
    0x22, 0x0, 0x6, 0x12, 0x1e, 0x14, 0x2e, 0x18,
    0x2e, 0x22, 0x2e, 0x6, 0x2e, 0x1e, 0x0, 0x0,
    0x0, 0x0, 0x24, 0x6,
]


# ══════════════════════════════════════════════════════════════════════════════
#  §1 — DEWHITEN FUNCTION
# ══════════════════════════════════════════════════════════════════════════════

def dewhiten(codewords: List[int], prng: List[int]) -> List[int]:
    """
    XOR each codeword byte with the corresponding PRNG byte.

    This exactly replicates gr-lora's dewhiten() (decoder_impl.cc ~line 639):

        for (i = 0; i < len; i++)
            d_words_dewhitened.push_back(d_words_deshuffled[i] ^ prng[i]);

    Parameters
    ----------
    codewords : list of int
        Deshuffled codeword bytes from Stage 5.
    prng : list of int
        Whitening PRNG table (must be at least len(codewords) long).

    Returns
    -------
    list of int : dewhitened codeword bytes.
    """
    return [(cw ^ prng[i]) & 0xFF for i, cw in enumerate(codewords)]


# ══════════════════════════════════════════════════════════════════════════════
#  §2 — SELECT PRNG TABLE BASED ON CR
# ══════════════════════════════════════════════════════════════════════════════

def select_payload_prng(cr: int) -> List[int]:
    """
    Return the correct payload whitening PRNG table for the given CR.

    gr-lora (decoder_impl.cc ~line 583):
        dewhiten(is_header ? prng_header :
            (d_phdr.cr <= 2) ? prng_payload_cr56 : prng_payload_cr78);
    """
    if cr <= 2:
        return PRNG_PAYLOAD_CR56
    else:
        return PRNG_PAYLOAD_CR78


# ══════════════════════════════════════════════════════════════════════════════
#  §3 — MAIN
# ══════════════════════════════════════════════════════════════════════════════

def main():
    ap = argparse.ArgumentParser(
        description="LoRa RX dewhitening: XOR codewords with PRNG sequence "
                    "to reverse the TX whitening.")
    ap.add_argument('input', nargs='?', default='lora_deshuffled.json',
                    help="Input JSON from deshuffle stage "
                         "(default: lora_deshuffled.json)")
    ap.add_argument('-o', '--output', default='lora_dewhitened.json',
                    help="Output JSON path (default: lora_dewhitened.json)")
    args = ap.parse_args()

    # ── Load deshuffled data ──────────────────────────────────────────────
    with open(args.input, 'r') as f:
        data = json.load(f)

    ds = data['deshuffled']
    header_cw   = ds['header']['codewords_ints']
    payload_cw  = ds['payload']['codewords_ints']

    # ── Determine CR ──────────────────────────────────────────────────────
    #  The payload CR should come from the decoded header, but at this point
    #  we haven't decoded the header yet.  Use the config value if available,
    #  otherwise default to CR=4.
    cr = data.get('deinterleave', {}).get('config', {}).get('cr')
    if cr is None:
        cr = data.get('config', {}).get('cr', 4)

    # ── Dewhiten header ───────────────────────────────────────────────────
    #  Header PRNG is all zeros → XOR is a no-op.  We apply it anyway for
    #  correctness and to show the step in the trace.
    header_dewhitened = dewhiten(header_cw, PRNG_HEADER)

    # ── Dewhiten payload ──────────────────────────────────────────────────
    #  Select PRNG based on CR.  For CR 3–4, use prng_payload_cr78.
    payload_prng = select_payload_prng(cr)
    payload_dewhitened = dewhiten(payload_cw, payload_prng)

    # ── Store results ─────────────────────────────────────────────────────
    data['dewhitened'] = {
        'header': {
            'codewords_ints': header_dewhitened,
        },
        'payload': {
            'codewords_ints': payload_dewhitened,
        },
        'prng_used': {
            'header': 'prng_header (all zeros)',
            'payload': f'prng_payload_cr{"78" if cr > 2 else "56"} (CR={cr})',
        },
    }

    with open(args.output, 'w') as f:
        json.dump(data, f, indent=2)

    # ── Summary ───────────────────────────────────────────────────────────
    def fmt(vals):
        return ' '.join(f'0x{v:02X}' for v in vals)

    def fmt_prng(prng, n):
        return ' '.join(f'0x{prng[i]:02X}' for i in range(n))

    n_hdr = len(header_cw)
    n_pay = len(payload_cw)

    print(f"CR = {cr}")
    print()
    print(f"Header  ({n_hdr} cw): prng_header (all zeros) → no change")
    print(f"  input : {fmt(header_cw)}")
    print(f"  output: {fmt(header_dewhitened)}")
    print()
    print(f"Payload ({n_pay} cw): prng_payload_cr{'78' if cr > 2 else '56'}")
    print(f"  input : {fmt(payload_cw)}")
    print(f"  prng  : {fmt_prng(payload_prng, n_pay)}")
    print(f"  output: {fmt(payload_dewhitened)}")
    print()
    print(f"Wrote dewhitened output to: {args.output}")


if __name__ == '__main__':
    main()
